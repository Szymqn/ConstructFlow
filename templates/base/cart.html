<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

<nav class="navbar navbar-dark sticky-top bg-primary">
    <a class="navbar-brand" href="/">ProConstruct</a>
    <ul class="nav justify-content">
        <li class="nav-item">
            <a class="nav-link " style="color: white; " href="{% url 'product-list' %}">Materiały Budowlane</a>
        </li>
        <li>
            <a class="nav-link" style="color: white;" href="{% url 'equipment-list' %}">Narzędzia</a>
        </li>
    </ul>
    {% if request.user.is_authenticated %}
        <div class="dropleft">
            <button class="btn btn-warning dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                {{ request.user.username }}
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="{% url 'cart' %}">Koszyk</a>
                <a class="dropdown-item" href="{% url 'user_details' %}">Twoje konto</a>
                <a class="dropdown-item" href="{% url 'logout' %}">Wyloguj się</a>
            </div>
        </div>
    {% else %}
        <div class="dropleft">
            <button class="btn btn-warning dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Gość
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="{% url 'login' %}">Zaloguj się</a>
                <a class="dropdown-item" href="{% url 'signup' %}">Zarejestruj się</a>
            </div>
        </div>
    {% endif %}
</nav>
{% load static %}
{% block content %}
<div class="container">
    <div class="cart-header">
        <h1>Koszyk</h1>
    </div>
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Nazwa produktu</th>
                    <th scope="col">Cena jednostkowa</th>
                    <th scope="col">Ilość</th>
                    <th scope="col">❌</th>
                </tr>
            </thead>
            <tbody>
             {% for item in cart_items %}
                <tr>
                {% if item.product %}
                    <td>{{ item.product.name }}</td>
                    <td>{{ item.product.price }}</td>
                    <td>
                    <button class="btn btn-danger" style="margin-left: 1rem;" onclick="updateQuantity('{{ item.id }}', 'decrement', 'product')">-</button>
                    <span id="product-quantity-{{ item.id }}">{{ item.product_quantity }}</span>
                    <button class="btn btn-success" style="margin-right: 1rem;" onclick="updateQuantity('{{ item.id }}', 'increment', 'product')">+</button>
                    </td>
                    <td>
                         <form action="{% if item.product.id %}{% url 'remove-product-from-cart' item.product.id %}{% endif %}" method="post">
                            {% csrf_token %}
                            <button class="btn btn-warning" type="submit">Usuń z koszyka</button>
                         </form>
                    </td>
                {%  elif item.equipment %}
                    <td>{{ item.equipment.name }}</td>
                    <td>{{ item.equipment.price }}</td>
                    <td>
                    <button class="btn btn-danger" style="margin-left: 1rem;" onclick="updateQuantity('{{ item.id }}', 'decrement', 'equipment')">-</button>
                    <span id="product-quantity-{{ item.id }}">{{ item.equipment_quantity }}</span>
                    <button class="btn btn-success" style="margin-right: 1rem;" onclick="updateQuantity('{{ item.id }}', 'increment', 'equipment')">+</button>
                    </td>
                    <td>
                         <form action="{% if item.equipment.id %}{% url 'remove-equipment-from-cart' item.equipment.id %}{% endif %}" method="post">
                            {% csrf_token %}
                            <button class="btn btn-warning" type="submit">Usuń z koszyka</button>
                         </form>
                    </td>
                {% endif %}
                </tr>
             {% endfor %}
            </tbody>
        </table>

    <div class="cart-total">
        <p>Łącznie: $<span id="total-amount">{{ total_amount }}</span></p>
    </div>
    Continue Shopping
    <a class="continue-shopping-link" href="{% url 'product-list' %}">Products</a>
    <a class="continue-shopping-link" href="{% url 'equipment-list' %}">Equipments</a>
    <a class="home" href="{% url 'home' %}">Home</a>

    <a class="checkout-button" href="#">Checkout</a>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
function updateQuantity(cartItemId, action, itemType) {
    $.ajax({
        url: `/update-quantity/${cartItemId}/${action}/${itemType}/`,
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                $(`#${itemType}-quantity-${cartItemId}`).text(response.quantity);
                $('#total-amount').text(response.totalAmount);
            } else {
                console.error('Error updating quantity:', response.error);
            }
        },
        error: function(error) {
            console.error('AJAX error:', error);
        }
    });
}
</script>
{% endblock %}
